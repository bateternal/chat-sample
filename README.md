# push with befrest

[![befrest](https://bef.rest/)]

پوش (push) #
ارتباط میان دستگاه‌های سرویس گیرنده با سرورهای پشتیبانی کننده آنها، در اکثر مواقع از سمت سرویس گیرنده آغاز می‌شود. ولیکن در مواقعی نیاز است سرور آغاز کننده ارتباط با دستگاه‌های سرویس گیرنده باشد. این نوع ارتباط به دلیل ارسال داده از سمت سرور به سرویس گیرنده، PUSH نامیده می‌شود. امروزه از این نوع ارتباط به طور معمول به منظور آگاه ساختن یا به روز کردن سرویس گیرنده‌ها نسبت به رویدادی خاص یا ارسال اطلاعات استفاده می‌شود. برای مطالعه بیشتر در این مورد اینجا کلیک کنید.

مکانیزمی که در اکثر پوش سیستم‌ها استفاده می‌شود به این شکل است که ابتدا client ارتباطی پایدار (persistent) را با سرور پوش برقرار کرده و سپس پیام‌های ارسالی از سمت سرور را دریافت می‌کند. همانطور که در بخش واژگان شرح داده شده است به ارتباط اولیه که توسط client برقرار می‌شود subscribe گفته شده و به انتشار پیام که بر روی ارتباط برقرار شده از سمت سرور پوش انجام می‌شود publish گفته می‌شود. در شکل زیر، تفاوت ارتباطات‌ یکبار مصرف که اکثر درخواست‌های وب از این نوع هستند و ارتباطات پایدار را می‌توانید مشاهده کنید.

![Screenshot](https://github.com/bateternal/chat-sample/blob/master1/chert/src/main/java/ir/oddrun/befrest/persistent_connection.svg)
همانگونه که در تصویر مشاهده می‌کنید در ارتباطات یکبار مصرف (سمت چپ) پس از ایجاد ارتباط از سمت کلاینت، سرور پاسخ لازم را ارسال کرده و سپس کلاینت به ارتباط ایجاد شده پایان می‌دهد. در صورتی که در سمت دیگر، کلاینت پس از ایجاد ارتباط،‌ به انتطار دریافت پیام‌(های) بعدی از سمت سرور می‌نشیند.

واژگان #
پیش از شروع استفاده از بفرست، نیاز است با واژگانی که در فناوری PUSH و بفرست به کار رفته است آشنا شوید. از واژگانی که شرح داده شده، در ادامه به دفعات استفاده خواهد شد. لذا مطالعه دقیق این واژگان به درک چگونگی استفاده از سرویس بفرست کمک خواهد کرد.

### subscribe
 درخواست برقراری ارتباط با درگاه بفرست است که از سمت اپلیکیشن موبایل یا هر نوع رسانه سمت کاربر صورت می‌گیرد. در نتیجه subscribe کردن، ارتباطی میان دستگاه کاربر (موبایل/تبلت/کامپیوتر شخصی یا ...) و درگاه بفرست برقرار می‌شود که کاربر می‌تواند پیام‌های ارسالی سرور را بر روی این ارتباط دریافت کند.

### publish
 درخواستی است از سمت کاربر به درگاه بفرست برای ارسال پیامی به یکی از کاربران اپلیکیشن خود.

### uid
شناسه‌ای است که بفرست به حساب کاربری شما نسبت می‌دهد.در بفرست از این شناسه در تشخیص کاربر استفاده می‌شود و همانطور که در بخش
 به منظور تشخیص کاربر گنجانده شود uid، مطالعه خواهید کرد لازم است در تمام درخواست‌ها endpoints

### chid
 شناسه‌ای است که معرف هر یک از کاربران شما در بفرست است. برای مثال بیایید فرض کنیم شما اپلیکیشن موبایلی دارید که کاربری با نام‌ X دارد. برای استفاده از سرویس بفرست و ارسال پوش نوتیفیکیشن به کاربر X، می‌بایست این کاربر به بفرست معرفی شود. این کار با انتخاب هر مقدار دل‌خواهی برای پارامتر chid از سمت شما انجام می‌شود. می‌توانید از یک رشته Alpha-numeric یا رشته عددی به عنوان مقدار chid در درخواست‌های خود برای ارسال پیام به کاربر X استفاده کنید. لطفا به این نکته دقت داشته باشید که chid هر کاربر اپلیکیشن شما می‌بایست یکتا بوده و تنها متعلق به آن کاربر باشد.

### shared key
 کلیدی است که از آن در ساختن رشته auth که در ادامه شرح داده شده استفاده می‌شود. این کلید توسط کاربر تعیین می‌شود و می‌تواند شامل حداقل ۳۲ و حداکثر ۴۸ کاراکتر Alpha-numeric باشد.

### api key
 کلیدی است که از آن در ساختن رشته auth که در ادامه شرح داده شده استفاده می‌شود. این کلید توسط بفرست تولید می‌شود و در اختیار کاربر قرار می‌گیرد.

### api version
 : سرویس‌های بفرست در قالب نسخه‌های متفاوتی ارائه می‌شود. در هر نسخه ممکن است قابلیت جدیدی افزوده شده و دیگر سرویس‌ها بهبود یافته باشند. با ارائه هر نسخه، بفرست تغییرات ایجاد شده در آن نسخه را با جزئیات، برای استفاده کاربران شرح خواهد داد. همچنین ممکن است با گذشت زمان نسخه‌های قدیمی‌تر با اطلاع رسانی پیشین دیگر پشتیبانی نشوند.

### auth
 رشته‌ای است که به منظور تشخیص هویت کاربر در درخواست‌هایی که به درگاه‌های بفرست ارسال می‌کند استفاده می‌شود. رشته auth وابسته به api key و shared key و آدرس درگاهی است که قصد فراخوانی آن را دارید. مراحل ایجاد رشته auth در ادامه شرح داده شده است.

ابتدا آدرس درگاهی که قصد فراخوانی آن را دارید به دو بخش (پروتکل +‌ دامنه +‌ پورت) و آدرس پس از دامنه تقسیم کنید. برای مثال در آدرس https://gw.bef.rest/xapi/1/publish/UID/CHID بخش اول https://gw.bef.rest و بخش دوم /xapi/1/publish/UID/CHID خواهد بود. بخش دوم آدرس را addr بنامید.

رشته‌ای با فرمت apikey,addr شکل دهید. دقت داشته باشید که apikey و addr با استفاده از کاراکتر comma از یکدیگر جدا شده‌اند و هیچ کاراکتر دیگری میان آنها وجود ندارد.
رشته بدست آمده از مرحله قبل را با الگوریتم MD5 رمز نگاری کنید.
آرایه بایت یا رشته باینری بدست آمده از مرحله قبل را با استفاده از الگوریتم BASE64 رمز نگاری کرده و آن را payload بنامید و سپس جایگزینی‌های زیر را انجام دهید.
کاراکترهای + را در payload با کاراکتر - جایگزین کنید
کاراکترهای = را در payload حذف کنید
کاراکترهای / را در payload با کاراکتر ـ (underscore) جایگزین کنید
رشته‌ای با فرمت sharedkey,payload شکل دهید و آن را با استفاده از الگوریتم MD5 رمز نگاری کنید. مانند مرحله نخست دقت داشته باشید که هر یک از پارامتر‌ها با استفاده از کاراکتر comma از یکدیگر جدا شده‌اند و هیچ کاراکتر دیگری میان آنها وجود ندارد.
آرایه بایت یا رشته باینری بدست آمده از مرحله قبل را با استفاده از الگوریتم BASE64 رمز نگاری کنید. سپس جایگزینی‌های مرحله ۳ را دوباره بر روی رشته بدست آمده انجام دهید
رشته بدست آمده auth نام دارد!
### channel id
 شناسه‌ای است یکتا برای هر subscriber متصل شده به بفرست که از ترکیب UID و CHID آن subscriber به شکل UID-CHID تولید می‌شود. فرض کنید شناسه کاربری شما (UID) در بفرست 1 باشد. حال کاربری که شما CHID با مقدار 100 به او اختصاص داده‌اید برای دریافت پوش نوتیفیکیشن‌های شما به بفرست متصل می‌شود. channel id این کاربر 1-100 خواهد بود.

### message id
 شناسه‌ای است که بفرست پس از دریافت درخواست ارسال پیام، به آن پیام اختصاص می‌دهد. کاربران می‌توانند از این شناسه برای بررسی وضعیت پیام ارسال شده استفاده کنند.

### topic name
 رشته‌ای است که به منظور گروه‌بندی کاربران اپلیکیشن شما استفاده می‌شود و می‌توانید با استفاده از آن پیامی را به صورت جمعی برای کاربران خود ارسال کنید. مثالی در این مورد کمک خواهد کرد تا مفهوم topic و topic name را بهتر متوجه شوید. فرض کنید شما اپلیکیشنی خبری با یک میلیون کاربر دارید. هر یک از کاربران در زمینه‌های مختلفی همچون اخبار سیاسی، ورزشی یا اجتماعی، علاقه‌مندی خود را در اپلیکیشن ثبت می‌کنند و انتظار دارند پس از انتشار اخبار در زمینه مد نظر ایشان، بلافاصله از انتشار خبر جدید مطلع شوند. با استفاده از قابلیت ارسال پیام تاپیک می‌توانید با انتشار اخبار سیاسی، تنها با یک publish کردن همه کاربرانی را که در انتظار اخبار سیاسی هستند مطلع کنید. topic name می‌تواند تنها از ترکیب کاراکترهای Alpha-numeric تشکیل شود و به صورت دل‌خواه و انتخابی توسط کاربر بفرست ایجاد می‌شود.

### topic message id
 که به اختصار MID در بفرست شناخته می‌شود، شناسه‌ای است که پس از انتشار پیام در تاپیک، به آن پیام اختصاص داده می‌شود. با استفاده از این شناسه می‌توانید وضعیت پیام ارسال شده در تاپیک را بررسی کنید.

درگاه‌های بفرست
در ادامه به تشریح درگاه‌های بفرست که پیش از این به برخی از آنها اشاره شد می‌پردازیم. در مطالعه مستندات درگاه‌ها لطفا به این نکات دقت کنید.

پیش از آدرس هریک از درگاه‌ها، Request method آن درگاه مشخص شده است.
UID و CHID در آدرس هر یک از درگاه‌ها می‌بایست با مقادیر معتبر جایگزین شوند.
درگاه‌های بفرست با توجه به قابلیت‌های ارائه شده، نسخه بندی شده‌اند. بفرست پس از ارائه نسخه‌ای جدید، نسخ پیشین را پشتیبانی خواهد کرد و با اطلاع قبلی آن نسخه‌ها را از فهرست درگاه‌های پشتیبانی شده خارج خواهد کرد. هم اکنون آخرین نسخه ارائه شده ‍1 است.
فیلد errorCode در پاسخ درگاه‌ها، نمایانگر نتیجه کلی درخواست است. مقدار 0 به معنای انجام موفقیت آمیز درخواست است. در صورت بروز خطا مقدار مرتبط با آن خطا در errorCode و پیامی در رابطه با آن خطا در فیلدی با نام message دریافت خواهید کرد.
